<!DOCTYPE html>
<html>
<head>
    <style>
        body{
            background-color: rgb(45, 127, 251);
        }
        canvas{
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
            border: 2px solid;
            background-color: white;
        }
        .colors{
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .color{
            width: 25px;
            height: 25px;
        }
        .word{
            padding: 0.4%;
            font-size: 1.5em;
            font-weight: bold;
            display: table;
            margin: 0 auto;
            margin-bottom: 0.4%;
            background-color: white;
            border-radius: 5%;
        }
        .brushes{
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .brush{
            border-radius: 50%;
            background-color: black;
        }
        .brushcontainer{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: white;
            width: 25px;
            height: 25px;
            border-radius: 10%;
            margin: 0.4%;
        }
        #messages > li{
            list-style: none;
        }
        .loginform{
            border-radius: 2%;
            margin-top: 20vh;
            margin-left: auto;
            margin-right: auto;
            width: 50%;
            background-color: rgb(45, 127, 251);
            padding: 45px;
            text-align: center;
            box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.2), 0 5px 5px 0 rgba(0, 0, 0, 0.24);
        }
        .loginform input{
            outline: 0;
            background: #f2f2f2;
            width: 100%;
            border: 0;
            margin: 0 0 15px;
            padding: 15px;
            box-sizing: border-box;
        }
        .loginform input[type=button]{
            text-transform: uppercase;
            outline: 0;
            background: #06F;
            width: 100%;
            border: 0;
            padding: 15px;
            color: #FFFFFF;
            font-size: 14px;
            -webkit-transition: all 0.3 ease;
            transition: all 0.3 ease;
            cursor: pointer;
            box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.2), 0 5px 5px 0 rgba(0, 0, 0, 0.24);
        }
    </style>
</head>
<body onload="init()">
    <section id="login">
        <form name="login" class="loginform">
            <input type="text" name="username" placeholder="Username">
            <input type="number" name="roomcode" placeholder="Room code (ignored if you create a room)">
            <input type="button" onclick="createRoom()" value="CREATE ROOM">
            <input type="button" onclick="joinRoom()" value="JOIN ROOM">
        </form>
    </section>
    <section id="game" style="display: none;">
        <span class="word" id="word">Cavallo</span>
        <canvas id="can" width="800" height="600"></canvas>
        <br>
        <div class="colors">
            <div class="color" style="background:black;" id="black" onclick="color(this)"></div>
            <div class="color" style="background:green;" id="green" onclick="color(this)"></div>
            <div class="color" style="background:blue;" id="blue" onclick="color(this)"></div>
            <div class="color" style="background:red;" id="red" onclick="color(this)"></div>
            <div class="color" style="background:yellow;" id="yellow" onclick="color(this)"></div>
            <div class="color" style="background:orange;" id="orange" onclick="color(this)"></div>
            <div class="color" style="background:purple;" id="purple" onclick="color(this)"></div>
            <div class="color" style="background:pink;" id="pink" onclick="color(this)"></div>
            <div class="color" style="background:brown;" id="brown" onclick="color(this)"></div>
            <div class="color" style="background:gray;" id="gray" onclick="color(this)"></div>
            <div class="color"></div><!-- space placeholder -->
            <div>Eraser</div>
            <div class="color"></div><!-- space placeholder -->
            <div class="color" style="background:white;border:2px solid;" id="white" onclick="color(this)"></div>
            <input type="button" value="clear" id="clr" size="23" onclick="erase()">
        </div>
        <div class="brushes">
            <div class="color"></div><!-- space placeholder -->
            <div class="brushcontainer" id="small" onclick="brush(this)">
                <div class="brush" style="width: 2px; height: 2px;"></div>
            </div>
            <div class="brushcontainer" id="medium" onclick="brush(this)">
                <div class="brush" style="width: 4px; height: 4px;"></div>
            </div>
            <div class="brushcontainer" id="large" onclick="brush(this)">
                <div class="brush" style="width: 8px; height: 8px;"></div>
            </div>
            <div class="brushcontainer" id="huge" onclick="brush(this)">
                <div class="brush" style="width: 12px; height: 12px;"></div>
            </div>
            <div class="brushcontainer" id="enormous" onclick="brush(this)">
                <div class="brush" style="width: 16px; height: 16px;"></div>
            </div>
                <button onclick="fillbg()">Fill</button>
        </div>
        <ul id="messages"></ul>
        <form id="form" action="">
        <input id="input" autocomplete="off" /><button>Send</button>
        </form>
        <input type="button" value="save" id="btn" size="30" onclick="save()" style="position:absolute;top:55%;left:10%;">
    </section>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var username;
        var room;
        function createRoom(){
            var usernamein = document.forms["login"]["username"].value;
            if(usernamein == "" || usernamein == null){
                alert("Fill in username");
                return;
            }
            username = usernamein;
            socket.emit('new room', username);
        }
        function joinRoom(){
            var usernamein = document.forms["login"]["username"].value;
            var roomcodein = document.forms["login"]["roomcode"].value;
            if (usernamein == "" || roomcodein == "" || usernamein == null || roomcodein == null) {
                alert("Please fill in all fields");
                return;
            }
            username = usernamein;
            room = roomcodein;
            socket.emit('join room', room, username);
        }
        var socket = io();
        var messages = document.getElementById('messages');
        var form = document.getElementById('form');
        var input = document.getElementById('input');

        form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
            socket.emit('chat message', input.value, room);
            input.value = '';
        }
        });

        socket.on('alert', function(msg) {
            alert(msg);
        });

        socket.on('created room', function(roomId) {
            console.log("created room " + roomId);
            socket.emit('join room', roomId, username); 
        });

        socket.on('room joined', function(roomId) {
            room = roomId;
            document.getElementById("login").style.display = "none";
            document.getElementById("game").style.display = "block";
        });

        socket.on('chat message', function(msg) {
            var item = document.createElement('li');
            item.textContent = msg;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });
    </script>
    <script>
    var canvas, ctx, flag = false,
        prevX = 0,
        currX = 0,
        prevY = 0,
        currY = 0,
        dot_flag = false;

    var selectedColor = "black",
        brushSize = 2;
    
    function init() {
        canvas = document.getElementById('can');
        ctx = canvas.getContext("2d");
        w = canvas.width;
        h = canvas.height;
    
        canvas.addEventListener("mousemove", function (e) {
            findxy('move', e)
        }, false);
        canvas.addEventListener("mousedown", function (e) {
            findxy('down', e)
        }, false);
        canvas.addEventListener("mouseup", function (e) {
            findxy('up', e)
        }, false);
        canvas.addEventListener("mouseout", function (e) {
            findxy('out', e)
        }, false);
    }
    /**
     * Function that, given an html object with the id
     * representing a color, checks if the color is allowed and
     * if it is, sets it as the current color.
    */
    function color(obj) {
        var allowedColors = [
            "green",
            "blue",
            "red",
            "yellow",
            "orange",
            "purple",
            "pink",
            "brown",
            "gray",
            "black",
            "white"
        ];
        if(allowedColors.includes(obj.id)){
            selectedColor = obj.id;
        }
    }
    /**
     * Function that, given an html object with the id
     * representing a brush size, sets the brush size.
    */
    function brush(obj){
        switch (obj.id) {
            case "small":
                brushSize = 2;
                break;
            case "medium":
                brushSize = 4;
                break;
            case "large":
                brushSize = 8;
                break;
            case "huge":
                brushSize = 12;
                break;
            case "enormous":
                brushSize = 16;
                break;
            case "default":
                brushSize = 2;
                break;
            default:
                brushSize = 2;
                break;
        }
    }
    function draw() {
        ctx.beginPath();
        ctx.lineCap = "round";
        ctx.strokeStyle = selectedColor;
        ctx.fillStyle = selectedColor;
        ctx.lineWidth = brushSize;
        ctx.moveTo(prevX, prevY);
        ctx.lineTo(currX, currY);
        ctx.stroke();
        ctx.closePath();
    }
    /**
     * Function that clears the canvas after asking confirmation
     * from the user.
    */
    function erase() {
        if (confirm("Sicuro di voler fare un clear?")) {
            ctx.clearRect(0, 0, w, h);
        }
    }
    function fillbg(){
        if (confirm("Sicuro di voler fare un fill " + selectedColor +"?")) {
            ctx.fillStyle = selectedColor;
            ctx.fillRect(0, 0, w, h);
        }
    }
    function save() {
        document.getElementById("canvasimg").style.border = "2px solid";
        var dataURL = canvas.toDataURL();
        //document.getElementById("canvasimg").src = dataURL;
        //document.getElementById("canvasimg").style.display = "inline";
    }
    
    function findxy(res, e) {
        if (res == 'down') {
            prevX = currX;
            prevY = currY;
            currX = e.clientX - canvas.offsetLeft;
            currY = e.clientY - canvas.offsetTop;
    
            flag = true;
            dot_flag = true;
            if (dot_flag) {
                ctx.beginPath();
                ctx.fillStyle = selectedColor;
                ctx.fillRect(currX, currY, 2, 2);
                ctx.closePath();
                dot_flag = false;
            }
        }
        if (res == 'up' || res == "out") {
            flag = false;
        }
        if (res == 'move') {
            if (flag) {
                prevX = currX;
                prevY = currY;
                currX = e.clientX - canvas.offsetLeft;
                currY = e.clientY - canvas.offsetTop;
                draw();
            }
        }
    }
    </script>
</body>
</html>