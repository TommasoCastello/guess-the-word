<!DOCTYPE html>
<html>

<head>
    <style>
        @keyframes fadein {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        body {
            background-color: rgb(45, 127, 251);
            overflow: hidden;
        }
        #login{
            -webkit-animation: fadein 1s; /* Safari, Chrome and Opera > 12.1 */
            -moz-animation: fadein 1s; /* Firefox < 16 */
            -o-animation: fadein 1s; /* Opera < 12.1 */
            animation: fadein 1s;
        }
        canvas {
            padding-left: 0;
            padding-right: 0;
            display: block;
            border: 2px solid;
            border-right: none;
            background-color: white;
            cursor: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAAAM1JREFUWEftk6ENgjEUhO93rWCJGlgAtkAiWaCdAQToToFkB/CwAJi3BOBJk1+RoO6RNOHqr7l8970Bnb+h835QQXYhERRBlgCbl4MiyBJg83JQBFkCbP6vHJwBmI/ELgDuLL2W9yI4BbBNKU3ap2b2ALAHcGNLehVcp5RWtdZlCOFZSjmb2RHAobuCMcZXzvnUW8Hm3+Zj4p2Hh14TtyWbh4tx0quHf55Hwqr2Ne9J8CclVZDFKoIiyBJg83JQBFkCbF4OiiBLgM137+AbRIYkKXyTNRMAAAAASUVORK5CYII=") 20 20, default;
        }

        #canvas-container{
            display: flex;
            margin-left: auto;
            margin-right: auto;
            width: fit-content;
        }

        #chat{
            flex: 1;
            background-color:  rgba(100,100,100,0.5);
            max-width: fit-content;
            border: 2px solid;
            overflow-y: scroll;
        }
        .colors {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .color {
            width: 25px;
            height: 25px;
        }

        .word {
            padding: 0.4%;
            font-size: 1.5em;
            font-weight: bold;
            display: table;
            margin: 0 auto;
            margin-bottom: 0.4%;
            background-color: white;
            border-radius: 5%;
        }

        .brushes {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .brush {
            border-radius: 50%;
            background-color: black;
        }

        .brushcontainer {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: white;
            width: 25px;
            height: 25px;
            border-radius: 10%;
            margin: 0.4%;
        }

        #messages>li {
            list-style: none;
        }

        #messages {
            height: 600px;
            min-height: 600px;
            width: 200px;
            overflow-y: scroll;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        .loginform {
            border-radius: 2%;
            margin-top: 12vh;
            margin-left: auto;
            margin-right: auto;
            width: 50%;
            background-color: rgb(45, 127, 251);
            padding: 45px;
            text-align: center;
            box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.2), 0 5px 5px 0 rgba(0, 0, 0, 0.24);
        }

        .loginform input {
            outline: 0;
            background: #f2f2f2;
            width: 100%;
            border: 0;
            margin: 0 0 15px;
            padding: 15px;
            box-sizing: border-box;
        }

        .loginform input[type=button] {
            text-transform: uppercase;
            outline: 0;
            background: #06F;
            width: 100%;
            border: 0;
            padding: 15px;
            color: #FFFFFF;
            font-size: 14px;
            -webkit-transition: all 0.3 ease;
            transition: all 0.3 ease;
            cursor: pointer;
            box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.2), 0 5px 5px 0 rgba(0, 0, 0, 0.24);
        }

        .topnav {
            position: relative;
            overflow: hidden;
            background-color: #333;
            margin-bottom: 10px;
            box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.2), 0 5px 5px 0 rgba(0, 0, 0, 0.24);
        }

        .topnav a {
            float: left;
            color: #f2f2f2;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            font-size: 1.2em;
        }

        .topnav a.active {
            background-color: #06F;
            color: white;
            font-size: 2em;
        }

        .topnav-centered a {
            float: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .topnav-right {
            float: right;
        }

        .topnavbutton {
            float: left;
            color: #f2f2f2;
            background-color: #333;
            text-align: center;
            padding: 14px 16px;
            border: none;
        }

        .topnavbutton:hover {
            background-color: #ddd;
            color: black;
        }

        /* Responsive navigation menu (for mobile devices) */
        @media screen and (max-width: 800px) {

            .topnav a,
            .topnav-right {
                float: none;
                display: block;
            }

            .topnav-centered a {
                position: relative;
                top: 0;
                left: 0;
                transform: none;
            }
        }

        #chooseword {
            list-style-type: none;
            margin: 0;
            padding: 0;
            padding-top: 0.5%;
            padding-bottom: 0.5%;
            margin-top: 0.5%;
            margin-bottom: 0.5%;
            overflow: hidden;
            background-color: #333;
            width: 50%;
            margin-left: auto;
            margin-right: auto;
        }

        #chooseword li {
            float: left;
            width: 33%;
        }

        #chooseword li a {
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }

        #chooseword li a:hover {
            background-color: rgb(215, 215, 215);
            color: #111;
        }

        #choosewordtitle {
            text-align: center;
        }
        #form{
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        #scoreboard{
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        #scoreboardlist>li{
            list-style-type: none;
            margin: 0;
            padding: 0;
            padding-top: 0.5%;
            padding-bottom: 0.5%;
            margin-top: 0.5%;
            margin-bottom: 0.5%;
            overflow: hidden;
            background-color: #333;
            width: 50%;
            margin-left: auto;
            margin-right: auto;
        }
        .styled-table {
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.9em;
            font-family: sans-serif;
            min-width: fit-content;
            width: 50%;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        }
        .scoreboardtitle{
            text-align: center;
            color: #ffffff;
        }
        .scoreboardtitle span{
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
        }
        .styled-table thead tr {
            background-color: #333;
            color: #ffffff;
            text-align: left;
        }
        .styled-table th,
        .styled-table td {
            text-align: center;
            padding: 12px 15px;
        }
        .styled-table tbody tr {
            border-bottom: 1px solid #dddddd;
            background-color: #f3f3f3;
        }

        .styled-table tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }

        .styled-table tbody tr:last-of-type {
            border-bottom: 2px solid #333;
        }
        .styled-table tbody tr :hover {
            font-weight: bold;
            color: #009879;
        }
        .maintitle{
            text-align: center;
            color: #ffffff;
            font-size: 3em;
        }
        .maintitle span{
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
        }
        .subtitle{
            text-align: center;
            color: #ffffff;
            font-size: medium;
        }
        .subtitle span{
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
        }
        .slide-in {
            z-index: 10; /* to position it in front of the other content */
            position: absolute;
            overflow: hidden; /* to prevent scrollbar appearing */
        }
        .slide-in.from-right .popup {
            transform: translateX(100%);
            -webkit-transform: translateX(100%);
        }
        .slide-in.from-right {
            right: 0;
        }
        .close {
            position: absolute;
            right: 0;
            top: 0;
            width: 32px;
            height: 32px;
            opacity: 0.6;
        }
        .close:hover {
            opacity: 1;
        }
        .close:before, .close:after {
            position: absolute;
            right: 15px;
            top: 0;
            content: ' ';
            height: 33px;
            width: 2px;
            background-color: rgb(255, 255, 255);
        }
        .close:before {
            transform: rotate(45deg);
        }
        .close:after {
            transform: rotate(-45deg);
        }
        .popup-content {
            margin: 10px;
            padding: 20px;
            width: 300px;
            height: 70px;
            background-color: #ffffff;
            opacity: 0.8;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        }
        #slider {
            position: absolute;
            z-index: 1;
            right: 0;
            bottom: 0;
            margin: 20px 10px;
            width: 400px;
            height: 130px;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            display: inline-block;
        }
        .slide-in {
            animation: slide-in 1s forwards;
            -webkit-animation: slide-in 0.8s forwards;
        }
        .slide-out {
            animation: slide-in 1s forwards;
            -webkit-animation: slide-out 0.8s forwards;
        }
        .gtfo{
            animation: gtfo 0.1s forwards;
            -webkit-animation: gtfo 0.1s forwards;
        }
            
        @keyframes slide-in {
            0% { transform: translateY(200%); }
            100% { transform: translateY(0%); }
        }

        @-webkit-keyframes slide-in {
            0% { transform: translateY(200%); }
            100% { -webkit-transform: translateY(0%); }
        }
            
        @keyframes slide-out {
            0% { transform: translateY(0%); }
            100% { transform: translateY(200%); }
        }

        @-webkit-keyframes slide-out {
            0% { -webkit-transform: translateY(0%); }
            100% { -webkit-transform: translateY(200%); }
        }
        @keyframes gtfo{
            0%{
                transform: translateY(200%);
            }
            100%{
                transform: translateY(200%);
            }
        }
        @-webkit-keyframes gtfo{
            0%{
                transform: translateY(200%);
            }
            100%{
                transform: translateY(200%);
            }
        }
    </style>
</head>

<body onload="init()">
    <div id="slider" class="gtfo">
        <a onclick="togglePopup()" class="close"></a>
        <p class="popup-content" id="popupmessage">Welcome to Guess the word!</p>
    </div>
    <section id="login">
        <h1 class="maintitle">
            <span>
                Guess the word
            </span>
        </h1>
        <h4 class="subtitle">
            <span>
                by TÃ¼mi and Jan
            </span>
        </h2>
        <form name="login" class="loginform">
            <input type="text" name="username" placeholder="Username">
            <input type="number" name="roomcode" placeholder="Room code (ignored if you create a room)">
            <input type="button" onclick="createRoom()" value="CREATE ROOM">
            <input type="button" onclick="joinRoom()" value="JOIN ROOM">
        </form>
    </section>
    <section id="mobile" style="display: none;">
        <h1 class="maintitle">
            <span>
                This website does not work on mobile.
            </span>
        </h1>
    </section>
    <section id="error" style="display: none;">
        <h1 class="maintitle">
            <span>
                Use a bigger window to play.
            </span>
        </h1>
    </section>
    <section id="game" style="display: none;">
        <!-- Top navigation -->
        <div class="topnav">

            <!-- Centered link -->
            <div class="topnav-centered">
                <a class="active" id="word">GUESS THE WORD</a>
            </div>

            <!-- Left-aligned links (default) -->
            <a class="topnavbutton" onclick="leaveRoom()">LEAVE ROOM</a>
            <!-- <a class="topnavbutton" onclick="destroyRoom()">DESTROY ROOM</a> -->
            <a id="startgamebutton" class="topnavbutton" style="display: none;" onclick="startGame()">START GAME</a>

            <!-- Right-aligned links -->
            <div class="topnav-right">
                <a class="topnavbutton" onclick="save(document.getElementById('can').toDataURL('image/jpg'), prompt('Enter a name for this image'));">SAVE</a>
                <a id="room"></a>
                <a id="time"></a>
                <a id="drawer"></a>
            </div>

        </div>
        <ul id="players"></ul>
        <div id="choosewordcontainer" style="display: none;">
            <h1 id="choosewordtitle">Choose a word</h1>
            <ul id="chooseword">
                <li><a id="cw1" onclick="sendWordChoice(0)"></a></li>
                <li><a id="cw2" onclick="sendWordChoice(1)"></a></li>
                <li><a id="cw3" onclick="sendWordChoice(2)"></a></li>
            </ul>
        </div>
        <!-- <div id="endroundcontainer" style="display: none;">
            <h1>Time's up! The word was <h1 id="endroundword"></h1></h1>
        </div> -->
        <div id="canvas-container">
            <canvas id="can" style="width: 800px; height: 600px;" width="800" height="600"></canvas>
            <div id="chat">
                <ul id="messages" ></ul>
                <form id="form" action="">
                    <input id="input" autocomplete="off" /><button>Send</button>
                </form>
            </div>
        </div>
        <br>
        <div class="colors">
            <div id="counter"></div>
            <div class="color" style="background:black;" id="black" onclick="color(this)"></div>
            <div class="color" style="background:green;" id="green" onclick="color(this)"></div>
            <div class="color" style="background:blue;" id="blue" onclick="color(this)"></div>
            <div class="color" style="background:red;" id="red" onclick="color(this)"></div>
            <div class="color" style="background:yellow;" id="yellow" onclick="color(this)"></div>
            <div class="color" style="background:orange;" id="orange" onclick="color(this)"></div>
            <div class="color" style="background:purple;" id="purple" onclick="color(this)"></div>
            <div class="color" style="background:pink;" id="pink" onclick="color(this)"></div>
            <div class="color" style="background:brown;" id="brown" onclick="color(this)"></div>
            <div class="color" style="background:gray;" id="gray" onclick="color(this)"></div>
            <div class="color"></div><!-- space placeholder -->
            <div>Eraser</div>
            <div class="color"></div><!-- space placeholder -->
            <div class="color" style="background:white;border:2px solid;" id="white" onclick="color(this)"></div>
            <input type="button" value="clear" id="clr" size="23" onclick="erase()">
        </div>
        <div class="brushes">
            <div class="color"></div><!-- space placeholder -->
            <div class="brushcontainer" id="small" onclick="brush(this)">
                <div class="brush" style="width: 2px; height: 2px;"></div>
            </div>
            <div class="brushcontainer" id="medium" onclick="brush(this)">
                <div class="brush" style="width: 4px; height: 4px;"></div>
            </div>
            <div class="brushcontainer" id="large" onclick="brush(this)">
                <div class="brush" style="width: 8px; height: 8px;"></div>
            </div>
            <div class="brushcontainer" id="huge" onclick="brush(this)">
                <div class="brush" style="width: 12px; height: 12px;"></div>
            </div>
            <div class="brushcontainer" id="enormous" onclick="brush(this)">
                <div class="brush" style="width: 16px; height: 16px;"></div>
            </div>
            <button onclick="fillbg()">Fill</button>
        </div>
    </section>
    <section id="scoreboard" style="display: none;">
        <table class="styled-table" id="scoreboardtable">
            <h1 class="scoreboardtitle"><span>Scoreboard</span></h1>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Username</th>
                    <th>Score</th>
                    <th>%</th>
                </tr>
            </thead>
        </table>
        <a class="topnavbutton" style="text-align: center;" onclick="leaveRoom()">Play again</a>
        <a class="topnavbutton" style="text-align: center;" onclick="socket.emit('download images', room);">Download images</a>
    </section>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var username;
        var room;
        var currentDrawer;
        var dontDraw = true;
        function createRoom() {
            var usernamein = document.forms["login"]["username"].value;
            if (usernamein == "" || usernamein == null) {
                showPopup("Fill in username");
                return;
            }
            username = usernamein;
            document.getElementById('startgamebutton').style.display = "block";
            socket.emit('new room', username);
        }
        function joinRoom() {
            var usernamein = document.forms["login"]["username"].value;
            var roomcodein = document.forms["login"]["roomcode"].value;
            if (usernamein == "" || roomcodein == "" || usernamein == null || roomcodein == null) {
                showPopup("Please fill in all fields");
                return;
            }
            username = usernamein;
            room = roomcodein;
            socket.emit('join room', room, username);
        }
        var socket = io();
        var messages = document.getElementById('messages');
        var form = document.getElementById('form');
        var input = document.getElementById('input');
        var guessed = false;

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            if (input.value) {
                socket.emit('chat message', input.value, room);
                input.value = '';
            }
        });

        socket.on('alert', function (msg) {
            showPopup(msg);
        });

        socket.on('created room', function (roomId) {
            console.log("created room " + roomId);
            socket.emit('join room', roomId, username);
        });

        socket.on('room joined', function (roomId) {
            room = roomId;
            console.log("joined room " + roomId);
            document.getElementById("login").style.display = "none";
            document.getElementById("game").style.display = "block";
            document.getElementById("room").innerText = "Room " + roomId;
            document.getElementById("word").innerText = "GUESS THE WORD";
            document.getElementById("time").innerText = "";
        });
        socket.on('player updated', function (players) {
            var playerslist = document.getElementById("players");
            playerslist.innerHTML = "";
            for (var i = 0; i < players.length; i++) {
                var player = document.createElement("li");
                player.innerText = players[i].name + " - " + players[i].points;
                playerslist.appendChild(player);
            }
        });
        socket.on('chat message', function (msgObj) {
            console.log(msgObj.msg);
            var item = document.createElement('li');
            item.textContent = msgObj.msg;
            item.style.color = msgObj.color;
            messages.appendChild(item);
            messages.scrollTo(0, messages.scrollHeight);
        });
        socket.on('room destroyed', function () {
            window.location.reload();
        });
        socket.on('words', async function (words) {
            dontDraw = true;
            document.getElementById("cw1").innerText = words[0];
            document.getElementById("cw2").innerText = words[1];
            document.getElementById("cw3").innerText = words[2];
            document.getElementById('input').disabled = true;
            await sleep(500);
            let op = 0;
            document.getElementById("choosewordcontainer").style.opacity = op;
            document.getElementById("choosewordcontainer").style.display = "block";
            let timer = setInterval(function () {
                op += 0.05;
                document.getElementById("choosewordcontainer").style.opacity = op;
                if(op >= 1) {
                    clearInterval(timer);
                }
            }, 50);
            
        });
        socket.on('draw canvas', function (data) {
            var ctx = document.getElementById("can").getContext("2d");
            switch (data.type) {
                case 'erase':
                    let tmp = ctx.fillStyle;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, w, h);
                    ctx.fillStyle = tmp;
                    break;
                case 'fill':
                    ctx.fillStyle = data.color;
                    ctx.fillRect(0, 0, w, h);
                    break;
                case 'draw':
                    ctx.beginPath();
                    ctx.lineCap = "round";
                    ctx.strokeStyle = data.color;
                    ctx.lineWidth = data.size;
                    ctx.lineJoin = "round";
                    ctx.moveTo(data.x, data.y);
                    ctx.lineTo(data.x1, data.y1);
                    ctx.stroke();
                    break;
            }

        });
        socket.on('current drawer', function (drawer) {
            currentDrawer = drawer;
            document.getElementById("drawer").innerText = drawer;
        });

        socket.on('timer', function (data) {
            console.log(data.countdown);
            document.getElementById('time').innerText = data.countdown;
        });
        socket.on('time up', function (word) {
            document.getElementById('time').innerText = "Time's up!";
            document.getElementById('word').innerText = word;
            currentDrawer = "";//prevents drawing for everyone
            document.getElementById('input').disabled = false;
            guessed = false;
            socket.emit('canvas data send',
                document.getElementById('can').toDataURL("image/jpg"),
                room);
            socket.emit('client canvas update', {
                x: currX,
                y: currY,
                x1: prevX,
                y1: prevY,
                color: selectedColor,
                size: brushSize,
                room: String(room),
                type: "erase"
            });
            let tmp = ctx.fillStyle;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, w, h);
            ctx.fillStyle = tmp;
        });
        socket.on('scoreboard', function (obj){
            console.log(obj);
            document.getElementById('game').style.display = "none";
            document.getElementById("scoreboard").style.display = "block";
            var table = document.getElementById('scoreboardtable');
            var tbody = document.createElement('tbody');
            for (var i = 0; i < obj.length; i++) {
                var player = document.createElement("tr");
                let name = obj[i].name;
                let points = obj[i].points + " points";
                if(obj[i].points == 1) {
                    points = obj[i].points + " point";
                }
                let percentage = (obj[i].guessed / obj[i].tries * 100).toFixed(0) + "%";
                percentage += "("+obj[i].guessed+"/"+obj[i].tries+")";
                player.innerHTML = "<td>" + (i+1) + "</td><td>" + name + "</td><td>" + points + "</td><td>" + percentage + "</td>";
                tbody.appendChild(player);
            }
            table.appendChild(tbody);
        });
        socket.on('full word for drawer', function (word) {
            document.getElementById('word').innerText = word;
        });
        socket.on('word hint', function (word) {
            if (currentDrawer == username || guessed) {
                return;
            }
            document.getElementById('word').innerText = word;
        });
        socket.on('guessed correctly', function (word) {
            document.getElementById('word').innerText = word;
            document.getElementById('input').disabled = true;
            guessed = true;
        });
        socket.on('game started', function () {
            document.getElementById('startgamebutton').style.display = 'none';
        });
        socket.on('images downloaded', function(images){
            console.log(images);
            for (const img of images) {
                save(img.data, img.name);
            }
        });
        function leaveRoom() {
            socket.emit('leave room', room);
            window.location.reload();
        }
        function destroyRoom() {
            socket.emit('destroy room', room);
        }
        function startGame() {
            socket.emit('start game', room);
        }
        function togglePopup(message){
            let $slider = document.getElementById('slider');
            let isOpen = $slider.classList.contains('slide-in');
            //console.log($slider.classList);
            if(!message){
                message = "";
            }
            document.getElementById('popupmessage').innerText = message;
            if(isOpen){
                $slider.removeAttribute('class', 'slide-in');
                $slider.setAttribute('class', 'slide-out');
            } else {
                $slider.removeAttribute('class', 'slide-out');
                $slider.setAttribute('class', 'slide-in');
            }
            return !isOpen;
        }
        async function showPopup(message){
            if(togglePopup(message)){
                await sleep(1500);
                togglePopup(message);
                return;
            }
            await sleep(1000);
            togglePopup(message);
            await sleep(1500);
            togglePopup(message);
        }
        function sendWordChoice(index) {
            document.getElementById('choosewordcontainer').style.display = 'none';
            socket.emit('get drawer', room);
            dontDraw = false;
            socket.emit('word picked', room, parseInt(index));
        }
        async function sleep(ms){
            return new Promise(resolve=>{
                setTimeout(resolve,ms)
            });
        }
        //if user is on a mobile device, disable log in
        if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            document.getElementById('login').style.display = 'none';
            document.getElementById('mobile').style.display = 'block';
        }
        //on resize if screen is smaller than 1060px, hide current section and show error
        window.addEventListener('resize', function () {
            //get all sections
            let sections = document.getElementsByTagName('section');
            //get current section
            let currentSection;
            for (const section of sections) {
                if(section.style.display == 'block'){
                    currentSection = section;
                    break;
                }
            }
            if(currentSection.id != 'game' && document.getElementById('error').style.display == 'none'){
                return;
            }
            if (window.innerWidth < 1000 || window.innerHeight < 850) {
                document.getElementById('game').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            } else {
                document.getElementById('game').style.display = 'block';
                document.getElementById('error').style.display = 'none';
            }
        });
    </script>
    <script>
        var canvas, ctx, flag = false,
            prevX = 0,
            currX = 0,
            prevY = 0,
            currY = 0,
            dot_flag = false;

        var selectedColor = "black",
            brushSize = 2;

        function init() {
            canvas = document.getElementById('can');
            ctx = canvas.getContext("2d");
            w = canvas.width;
            h = canvas.height;

            canvas.addEventListener("mousemove", function (e) {
                findxy('move', e)
            }, false);
            canvas.addEventListener("mousedown", function (e) {
                findxy('down', e)
            }, false);
            canvas.addEventListener("mouseup", function (e) {
                findxy('up', e)
            }, false);
            canvas.addEventListener("mouseout", function (e) {
                findxy('out', e)
            }, false);
            let tmp = ctx.fillStyle;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, w, h);
            ctx.fillStyle = tmp;
        }
        /**
         * Function that, given an html object with the id
         * representing a color, checks if the color is allowed and
         * if it is, sets it as the current color.
        */
        function color(obj) {
            var allowedColors = [
                "green",
                "blue",
                "red",
                "yellow",
                "orange",
                "purple",
                "pink",
                "brown",
                "gray",
                "black",
                "white"
            ];
            if (allowedColors.includes(obj.id)) {
                selectedColor = obj.id;
            }
        }
        /**
         * Function that, given an html object with the id
         * representing a brush size, sets the brush size.
        */
        function brush(obj) {
            switch (obj.id) {
                case "small":
                    brushSize = 2;
                    break;
                case "medium":
                    brushSize = 4;
                    break;
                case "large":
                    brushSize = 8;
                    break;
                case "huge":
                    brushSize = 12;
                    break;
                case "enormous":
                    brushSize = 16;
                    break;
                case "default":
                    brushSize = 2;
                    break;
                default:
                    brushSize = 2;
                    break;
            }
        }
        function draw() {
            socket.emit('client canvas update', {
                x: currX,
                y: currY,
                x1: prevX,
                y1: prevY,
                color: selectedColor,
                size: brushSize,
                room: String(room),
                type: "draw"
            });
            ctx.beginPath();
            ctx.lineCap = "round";
            ctx.strokeStyle = selectedColor;
            ctx.fillStyle = selectedColor;
            ctx.lineWidth = brushSize;
            ctx.moveTo(prevX, prevY);
            ctx.lineTo(currX, currY);
            ctx.stroke();
            ctx.closePath();
        }
        function erase() {
            if (username != currentDrawer || dontDraw) {
                return;
            }
            if (confirm("Sicuro di voler fare un clear?")) {
                socket.emit('client canvas update', {
                    x: currX,
                    y: currY,
                    x1: prevX,
                    y1: prevY,
                    color: selectedColor,
                    size: brushSize,
                    room: String(room),
                    type: "erase"
                });
                let tmp = ctx.fillStyle;
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, w, h);
                ctx.fillStyle = tmp;
            }
        }
        function fillbg() {
            if (username != currentDrawer || dontDraw) {
                return;
            }
            if (confirm("Sicuro di voler fare un fill " + selectedColor + "?")) {
                socket.emit('client canvas update', {
                    x: currX,
                    y: currY,
                    x1: prevX,
                    y1: prevY,
                    color: selectedColor,
                    size: brushSize,
                    room: String(room),
                    type: "fill"
                });
                ctx.fillStyle = selectedColor;
                ctx.fillRect(0, 0, w, h);
            }
        }
        function save(data, name) {
            var link = document.createElement('a');
            link.download = name + '.jpg';
            link.href = data;
            link.click();
        }

        function findxy(res, e) {
            const rect = canvas.getBoundingClientRect();
            if (username != currentDrawer || dontDraw) {
                return;
            }
            if (res == 'down') {
                prevX = currX;
                prevY = currY;
                currX = e.pageX - rect.left;
                currY = e.pageY - rect.top;

                flag = true;
                dot_flag = true;
                // if (dot_flag) {
                //     ctx.beginPath();
                //     ctx.fillStyle = selectedColor;
                //     ctx.fillRect(currX, currY, 2, 2);
                //     ctx.closePath();
                //     dot_flag = false;
                // }
            }
            if (res == 'up' || res == "out") {
                flag = false;
            }
            if (res == 'move') {
                if (flag) {
                    prevX = currX;
                    prevY = currY;
                    currX = e.pageX - rect.left;
                    currY = e.pageY - rect.top;
                    draw();
                }
            }
        }

    </script>
</body>

</html>